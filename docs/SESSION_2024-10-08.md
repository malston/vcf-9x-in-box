# VCF 9.x in a Box - Session Summary (2024-10-08)

## Project Overview
VMware Cloud Foundation (VCF) 9.x deployment automation for home lab environments using Minisforum MS-A2 systems.

**Repository:** `/Users/markalston/workspace/vcf-9x-in-box`

## Session Accomplishments

### 1. README.md Comprehensive Improvements
- ✅ Added Quick Start section (10-step overview with 3-4 hour timeline)
- ✅ Added Minimum Resources section (hardware, network, software requirements)
- ✅ Added Configuration Files reference table
- ✅ Added Automation Scripts table with prerequisites
- ✅ Added detailed Script Prerequisites section for all scripts
- ✅ Added comprehensive Troubleshooting section (ESXi, VCF, DNS, Network issues)
- ✅ Improved Step 4 with direct config file links
- ✅ Improved Step 8 with detailed script usage examples
- ✅ Improved Step 12 with proactive vSAN policy fix approach
- ✅ Fixed changelog dates (2025 → 2024)

### 2. Network Configuration Updates
**Changed ESXi host IP addresses:**
- ESX01: ~~172.30.0.110~~ → **172.30.0.10**
- ESX02: ~~172.30.0.120~~ → **172.30.0.11**

**Updated files:**
- `README.md` - IP address table
- `scripts/deploy_vcf_installer.sh` - ESXI_HOST variable
- `scripts/prepare_esxi_reinstall.sh` - ESX01_IP and ESX02_IP variables
- `config/ks-esx01.cfg` - Already had correct IP (.10)
- `config/ks-esx02.cfg` - Already had correct IP (.11)

### 3. New Script: prepare_esxi_reinstall.sh
Created comprehensive automation script (392 lines) that:
- Generates kickstart configs with correct network settings (VLAN 30, 172.30.0.0/24)
- Creates BOOT.CFG template for USB boot configuration
- Generates detailed installation instructions (INSTALLATION_INSTRUCTIONS.md)
- Supports customization for NVMe device identifiers
- Updates both working directory and config/ directory files
- Includes comprehensive error checking and colored output

**Features:**
- Automated kickstart generation for both hosts
- Network configuration: 172.30.0.10/11, VLAN 30, gateway 172.30.0.1
- NVMe tiering support
- vSAN ESA Mock VIB installation
- AMD Ryzen CPU workarounds
- SSH key support (optional)
- MTU 9000 (jumbo frames)

### 4. Created Comprehensive .gitignore
Added `.gitignore` with:
- OS-specific files (macOS, Windows, Linux)
- Large binary files (ISOs, OVAs, VMDKs)
- VCF offline depot directories
- ESXi installation working directories
- Sensitive files (keys, credentials)
- IDE/editor directories
- `.claude/` directory
- Logs and temporary files

### 5. Git Branch Management
- Created branch: `update-network-config`
- Committed changes locally (2 commits)
- **NOT pushed to remote** (local only)

**Commits:**
1. `38f53cd` - Network config updates, README improvements, new prepare script
2. `0f55c11` - Added .gitignore

## Network Configuration

### Current Setup
- **Network:** 172.30.0.0/24
- **Management VLAN:** 30
- **Gateway:** 172.30.0.1
- **DNS:** 172.30.0.2
- **Domain:** vcf.lab
- **Switch:** MikroTik CRS304-4XG-IN (VLAN 30 configured)

### IP Address Allocation

| IP Address | Hostname | Component |
|------------|----------|-----------|
| 172.30.0.2 | dns.vcf.lab | DNS Server (optional) |
| 172.30.0.10 | esx01.vcf.lab | Physical ESXi Host 1 |
| 172.30.0.11 | esx02.vcf.lab | Physical ESXi Host 2 |
| 172.30.0.12 | sddcm01.vcf.lab | VCF Installer/SDDC Manager |
| 172.30.0.13 | vc01.vcf.lab | vCenter Server |
| 172.30.0.14 | vcf01.vcf.lab | VCF Operations |
| 172.30.0.15 | nsx01.vcf.lab | NSX Manager VIP |
| 172.30.0.16 | mgmt-nsx01a.vcf.lab | NSX Manager Node |
| 172.30.0.17 | edge01a.vcf.lab | NSX Edge 1a |
| 172.30.0.18 | edge01b.vcf.lab | NSX Edge 1b |
| 172.30.0.19 | opsfm01.vcf.lab | VCF Operations Fleet Manager |
| 172.30.0.20 | opsproxy01.vcf.lab | VCF Operations Proxy |
| 172.30.0.30 | auto01.vcf.lab | VCF Automation |

### VLAN Configuration
- VLAN 30 - Management
- VLAN 40 - vMotion
- VLAN 50 - vSAN
- VLAN 60 - ESX/NSX Edge TEP
- VLAN 70 - Tier 0 Uplink (Optional)

## Hardware Configuration

### Current MS-A2 Systems (2 units)
- **CPU:** AMD Ryzen 9 7945HX (16C/32T, up to 5.4 GHz)
- **RAM:** 128GB DDR5 per host
- **Storage:**
  - 500GB NVMe for ESXi OS, ESX-OSData & Local VMFS
  - 1-2TB NVMe for vSAN ESA
  - 1TB NVMe for NVMe Tiering
- **Network:** 2x SFP+ 10G ports, 2x 2.5G LAN ports

### Network Infrastructure
- **Switch:** MikroTik CRS304-4XG-IN (10GbE)
- **Existing Ubiquiti gear:** UXG-Lite gateway, multiple switches, UAPs

## Project Structure

### Configuration Files (`config/`)
| File | Purpose |
|------|---------|
| `ks-esx01.cfg` | ESXi kickstart for host 1 (172.30.0.10) |
| `ks-esx02.cfg` | ESXi kickstart for host 2 (172.30.0.11) |
| `vcf90-two-node.json` | VCF deployment manifest |
| `unbound.conf` | Optional DNS server configuration |

### Automation Scripts (`scripts/`)
| Script | Purpose |
|--------|---------|
| `deploy_vcf_installer.sh` | Deploy VCF Installer appliance via OVFTool |
| `setup_vcf_installer.ps1` | Configure VCF Installer post-deployment |
| `fix_vsan_esa_default_storage_policy.ps1` | Auto-fix vSAN ESA policy for single/dual hosts |
| `prepare_esxi_reinstall.sh` | **NEW** - Automate ESXi reinstallation prep |

## Deployment Workflow

### Phase 1: ESXi Host Preparation (Using New Script)
1. **Customize `prepare_esxi_reinstall.sh`:**
   - Verify NVMe device identifiers (use `vdq -q` in ESXi console)
   - Update ESXi ISO path
   - Verify network settings

2. **Run preparation script:**
   ```bash
   cd scripts
   ./prepare_esxi_reinstall.sh
   ```

3. **Create bootable USB drives:**
   - Use UNetbootin to create bootable ESXi installer
   - Copy `ks-esx01.cfg` → USB root as `KS.CFG` (for host 1)
   - Copy `ks-esx02.cfg` → USB root as `KS.CFG` (for host 2)
   - Modify `EFI/BOOT/BOOT.CFG` with template from script output

4. **Install ESXi:**
   - Boot each MS-A2 from USB
   - Installation proceeds automatically
   - Two reboots occur (initial install + firstboot config)
   - Verify hosts at 172.30.0.10 and 172.30.0.11

### Phase 2: VCF Installer Deployment
1. Setup VCF Offline Depot (HTTP server)
2. Run `deploy_vcf_installer.sh`
3. Run `setup_vcf_installer.ps1`
4. Connect to Offline Depot and download binaries

### Phase 3: VCF Fleet Deployment
1. Upload `vcf90-two-node.json` manifest
2. Start deployment
3. **CRITICAL:** Run `fix_vsan_esa_default_storage_policy.ps1` immediately
4. Wait 3-4 hours for completion

## Critical Information

### ESXi Host Modifications by VCF
The VCF Installer makes EXTENSIVE changes to ESXi hosts:
- ✓ Joins hosts to vCenter Server
- ✓ Configures vSAN ESA on NVMe devices
- ✓ Creates/configures vSphere Distributed Switch (VDS)
- ✓ Configures VMkernel adapters (vMotion, vSAN, NSX TEP)
- ✓ Applies VLAN configurations
- ✓ Installs NSX components
- ✓ Deploys management VMs (NSX Edges)
- ✓ Hosts become fully integrated VCF management domain members

**Result:** Hosts are NOT vanilla ESXi anymore - they're full VCF infrastructure.

### vSAN Storage Policy Fix (CRITICAL)
For single/dual host deployments:
- Default vSAN ESA policy requires 3 hosts → WILL FAIL
- Must run `fix_vsan_esa_default_storage_policy.ps1` PROACTIVELY
- Script monitors vCenter deployment and auto-updates policy
- Prevents deployment failure requiring manual remediation

### Prerequisites Documented
All scripts now have detailed prerequisites in README:
- `deploy_vcf_installer.sh` - OVFTool, ESXi with SSH, datastore space
- `setup_vcf_installer.ps1` - PowerShell 7+, PowerCLI module
- `fix_vsan_esa_default_storage_policy.ps1` - PowerCLI, vCenter access
- `prepare_esxi_reinstall.sh` - ESXi ISO, NVMe device IDs

### NVMe Device Identifiers
**IMPORTANT:** Each MS-A2 has unique NVMe device identifiers

**How to find:**
1. Boot ESXi installer (without kickstart)
2. Press ALT+F1 (console)
3. Login as `root` (blank password)
4. Run: `/etc/init.d/SSH start`
5. SSH to host, run: `vdq -q`
6. Note device labels (e.g., `eui.xxxxx`, `t10.NVMe____xxxx`)
7. Update in `prepare_esxi_reinstall.sh`

## User Context (Mark's Home Lab)

From CLAUDE.md:
- Existing 3x Intel NUC6i7KYK vSphere cluster
- Ubiquiti networking (UXG-Lite, switches, UAPs)
- Synology DS918+ NAS
- Planning MS-A2 upgrade for Tanzu workloads (TKG, TAS)
- Already has 2 MS-A2 units running on 192.168.10.0/24
- Wants to move to 172.30.0.0/24 on VLAN 30 (MikroTik configured)

## Next Steps

1. ✅ **Verify NVMe device identifiers** in `prepare_esxi_reinstall.sh`
2. ✅ **Run preparation script** to generate configs and instructions
3. ⏳ **Create bootable USB drives** using UNetbootin
4. ⏳ **Reinstall ESXi hosts** with new network config (172.30.0.10/11)
5. ⏳ **Setup VCF Offline Depot** (HTTP server with binaries)
6. ⏳ **Deploy VCF Installer** using `deploy_vcf_installer.sh`
7. ⏳ **Configure VCF Installer** using `setup_vcf_installer.ps1`
8. ⏳ **Deploy VCF Fleet** using manifest
9. ⏳ **Run storage policy fix** proactively during deployment

## Git Status

**Current branch:** `update-network-config`

**Commits (local only, not pushed):**
```
0f55c11 Add comprehensive .gitignore for VCF lab environment
38f53cd Update network configuration and add ESXi reinstallation automation
```

**Files modified:**
- `README.md` (221 insertions)
- `scripts/deploy_vcf_installer.sh` (4 changes)
- `scripts/prepare_esxi_reinstall.sh` (392 insertions, NEW)
- `.gitignore` (140 insertions, NEW)

**To push:**
```bash
git push -u origin update-network-config
```

## Documentation Guidelines

Per `CLAUDE.local.md`:
- Always use generic company names in examples
- ✓ Good: ACME Corp, Example Corp, Generic Corp
- ✗ Avoid: Real company names (Wells Fargo, Microsoft, etc.)

## Questions Answered in Session

1. **ESXi prerequisites for deploy_vcf_installer.sh?**
   - SSH enabled, root access, datastore with 15-20GB, VM Network port group

2. **Does installer create vCenter or is it required?**
   - VCF Installer creates vCenter automatically (no pre-existing vCenter needed)

3. **Do scripts/installer modify ESXi hosts?**
   - Yes, EXTENSIVELY - joins to vCenter, configures vSAN, VDS, NSX, deploys VMs

4. **IP address documentation?**
   - Full table in README Prereq section (172.30.0.0/24 range)

## Files Generated by prepare_esxi_reinstall.sh

When run, creates in `esxi-reinstall-temp/`:
- `ks-esx01.cfg` - Kickstart for host 1
- `ks-esx02.cfg` - Kickstart for host 2
- `BOOT.CFG.template` - USB boot configuration template
- `INSTALLATION_INSTRUCTIONS.md` - Detailed step-by-step guide

Also updates:
- `config/ks-esx01.cfg`
- `config/ks-esx02.cfg`

---

**Session Duration:** ~2 hours
**Files Created:** 4
**Files Modified:** 3
**Documentation Improvements:** Extensive (README ~200 lines added)
**Scripts Created:** 1 (prepare_esxi_reinstall.sh, 392 lines)
